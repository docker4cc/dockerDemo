# 自己动手写Docker系列 -- 6.3给容器配置网络
***

## 简介
在前面的文章中，我们完成了创建虚拟网络，并且能看查看网络列表和删除网络，本篇文件将用上篇创建的网络给容器进行配置，让容器网络功能正常

## 源码说明
同时放到了Gitee和Github上，都可进行获取

- [Gitee: https://gitee.com/free-love/docker-demo](https://gitee.com/free-love/docker-demo)
- [GitHub: https://github.com/lw1243925457/dockerDemo](https://github.com/lw1243925457/dockerDemo)

本章节对应的版本标签是：6.3，防止后面代码过多，不好查看，可切换到标签版本进行查看

## 代码实现

## 测试运行
```shell
./main network create --driver bridge --subnet 192.168.10.1/24 testbridge
./main network list

# route add -net 0.0.0.0/0 gw 192.168.10.1 dev 74818@if20
./main run -ti -net testbridge -name test1 sh
./main run -ti -net testbridge sh

echo "nameserver 114.114.114.114" > /etc/resolv.conf
```

```shell
/ # ip link
1: lo: <LOOPBACK> mtu 65536 qdisc noop qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
23: 96484@if22: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop qlen 1000
    link/ether 2e:9e:9b:b4:4d:bd brd ff:ff:ff:ff:ff:ff
/ # ip link set 96484 up
/ # route add default dev 74818
route: SIOCADDRT: No such device
/ # route add default dev 96484
/ # ping 192.168.7
ping: bad address '192.168.7'
/ # ping 192.168.10.7
PING 192.168.10.7 (192.168.10.7): 56 data bytes
^X^C
--- 192.168.10.7 ping statistics ---
184 packets transmitted, 0 packets received, 100% packet loss
/ # ifconfig 96484 192.168.10.8 up
/ # ping 192.168.10.7
PING 192.168.10.7 (192.168.10.7): 56 data bytes
^C
--- 192.168.10.7 ping statistics ---
20 packets transmitted, 0 packets received, 100% packet loss
/ # ifconfig
96484     Link encap:Ethernet  HWaddr 2E:9E:9B:B4:4D:BD
          inet addr:192.168.10.8  Bcast:192.168.10.255  Mask:255.255.255.0
          inet6 addr: fe80::2c9e:9bff:feb4:4dbd/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:19 errors:0 dropped:2 overruns:0 frame:0
          TX packets:216 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:2716 (2.6 KiB)  TX bytes:20928 (20.4 KiB)

/ # ping -c 1 192.168.10.7
PING 192.168.10.7 (192.168.10.7): 56 data bytes

--- 192.168.10.7 ping statistics ---
1 packets transmitted, 0 packets received, 100% packet loss
/ #

/ # route add default gw 192.168.10.1 dev 96484
/ #
```

```shell
/ # ip link
1: lo: <LOOPBACK> mtu 65536 qdisc noop qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
32: cif-42816@if33: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop qlen 1000
    link/ether fa:6a:ba:eb:21:70 brd ff:ff:ff:ff:ff:ff
/ # ifconfig cif-42816 192.168.10.13 up
/ # ifconfig
cif-42816 Link encap:Ethernet  HWaddr FA:6A:BA:EB:21:70
          inet addr:192.168.10.13  Bcast:192.168.10.255  Mask:255.255.255.0
          inet6 addr: fe80::f86a:baff:feeb:2170/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:4 errors:0 dropped:2 overruns:0 frame:0
          TX packets:6 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:480 (480.0 B)  TX bytes:516 (516.0 B)

/ # ping 192.168.110.13
PING 192.168.110.13 (192.168.110.13): 56 data bytes
ping: sendto: Network is unreachable
/ # ping -c 1 192.168.110.13
PING 192.168.110.13 (192.168.110.13): 56 data bytes
ping: sendto: Network is unreachable
/ # route list
BusyBox v1.34.1 (2022-03-10 23:58:34 UTC) multi-call binary.

Usage: route [-ne] [-A inet[6]] [{add|del} [-net|-host] TARGET [netmask MASK]
        [gw GATEWAY] [metric N] [mss BYTES] [window BYTES] [reject] [IFACE]]

Show or edit kernel routing tables

        -n      Don't resolve names
        -e      Display other/more information
        -A inet[6]      Select address family
/ # ip route
192.168.10.0/24 dev cif-42816 scope link  src 192.168.10.13
/ # ifconfig
cif-42816 Link encap:Ethernet  HWaddr FA:6A:BA:EB:21:70
          inet addr:192.168.10.13  Bcast:192.168.10.255  Mask:255.255.255.0
          inet6 addr: fe80::f86a:baff:feeb:2170/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:12 errors:0 dropped:2 overruns:0 frame:0
          TX packets:10 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:1686 (1.6 KiB)  TX bytes:796 (796.0 B)

/ # ifconfig lo 127.0.0.1 up
/ # ifconfig
cif-42816 Link encap:Ethernet  HWaddr FA:6A:BA:EB:21:70
          inet addr:192.168.10.13  Bcast:192.168.10.255  Mask:255.255.255.0
          inet6 addr: fe80::f86a:baff:feeb:2170/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:12 errors:0 dropped:2 overruns:0 frame:0
          TX packets:11 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:1686 (1.6 KiB)  TX bytes:866 (866.0 B)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

/ # ping -c 1 192.168.110.13
PING 192.168.110.13 (192.168.110.13): 56 data bytes
ping: sendto: Network is unreachable
/ # ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
32: cif-42816@if33: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue qlen 1000
    link/ether fa:6a:ba:eb:21:70 brd ff:ff:ff:ff:ff:ff
    inet 192.168.10.13/24 brd 192.168.10.255 scope global cif-42816
       valid_lft forever preferred_lft forever
    inet6 fe80::f86a:baff:feeb:2170/64 scope link
       valid_lft forever preferred_lft forever
/ # cat /etc/network/if-
if-down.d/       if-post-down.d/  if-pre-up.d/     if-up.d/
/ # cat /etc/network/if-
if-down.d/       if-post-down.d/  if-pre-up.d/     if-up.d/
/ # cat /etc/network/if-^C
/ # route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.10.0    *               255.255.255.0   U     0      0        0 cif-42816
/ # route add default gw 192.168.10.1
/ # route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192.168.10.1    0.0.0.0         UG    0      0        0 cif-42816
192.168.10.0    *               255.255.255.0   U     0      0        0 cif-42816
/ # ping www.baidu.com
ping: bad address 'www.baidu.com'
/ # ping 127.0.0.1
PING 127.0.0.1 (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: seq=0 ttl=64 time=0.051 ms
64 bytes from 127.0.0.1: seq=1 ttl=64 time=0.066 ms
64 bytes from 127.0.0.1: seq=2 ttl=64 time=0.060 ms
^C
--- 127.0.0.1 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 0.051/0.059/0.066 ms
/ # ping 192.168.10.13
PING 192.168.10.13 (192.168.10.13): 56 data bytes
64 bytes from 192.168.10.13: seq=0 ttl=64 time=0.051 ms
64 bytes from 192.168.10.13: seq=1 ttl=64 time=0.055 ms
^C
--- 192.168.10.13 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 0.051/0.053/0.055 ms
/ # ping 192.168.10.8
PING 192.168.10.8 (192.168.10.8): 56 data bytes
64 bytes from 192.168.10.8: seq=0 ttl=64 time=0.115 ms
64 bytes from 192.168.10.8: seq=1 ttl=64 time=0.087 ms
64 bytes from 192.168.10.8: seq=2 ttl=64 time=0.093 ms
64 bytes from 192.168.10.8: seq=3 ttl=64 time=0.084 ms
64 bytes from 192.168.10.8: seq=4 ttl=64 time=0.085 ms
64 bytes from 192.168.10.8: seq=5 ttl=64 time=0.087 ms
64 bytes from 192.168.10.8: seq=6 ttl=64 time=0.090 ms
^C
--- 192.168.10.8 ping statistics ---
7 packets transmitted, 7 packets received, 0% packet loss
round-trip min/avg/max = 0.084/0.091/0.115 ms
/ #
```